<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Online Rus Ruleti</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --panel: #020617;
      --card: #0f172a;
      --accent: #facc15;
      --accent-soft: rgba(250, 204, 21, 0.15);
      --danger: #f87171;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        sans-serif;
      background: radial-gradient(circle at top, #0b1120, #020617 55%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: stretch;
      min-height: 100vh;
    }

    .app {
      max-width: 960px;
      width: 100%;
      padding: 24px 16px 32px;
    }

    .card {
      position: relative;
      background: radial-gradient(circle at top, #020617, #020617 40%),
        var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(75, 85, 99, 0.4);
      backdrop-filter: blur(24px);
    }

    h1 {
      margin-top: 0;
      font-size: 2rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 span.icon {
      font-size: 2.2rem;
    }

    .subtitle {
      color: var(--text-soft);
      margin-bottom: 12px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 16px;
    }

    .col {
      flex: 1 1 260px;
    }

    label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
    }

    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.3);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(to right, #fde047, #f97316);
      color: #1f2937;
      box-shadow: 0 8px 25px rgba(234, 179, 8, 0.45);
      transition: transform 0.1s, box-shadow 0.1s, filter 0.15s;
    }

    button.secondary {
      background: transparent;
      border: 1px solid #4b5563;
      color: var(--text-soft);
      box-shadow: none;
    }

    button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }

    button[disabled] {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .section-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(75, 85, 99, 0.7);
      color: var(--text-soft);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.7);
    }

    .pill-dot.red {
      background: #f97373;
      box-shadow: 0 0 8px rgba(248, 113, 113, 0.7);
    }

    .players {
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      padding: 10px 12px;
      max-height: 220px;
      overflow-y: auto;
      font-size: 0.85rem;
    }

    .player-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(31, 41, 55, 0.7);
    }

    .player-row:last-child {
      border-bottom: none;
    }

    .player-name {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .player-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    .player-dot.dead {
      background: #4b5563;
    }

    .player-tag {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: #9ca3af;
    }

    .status-banner {
      margin-top: 16px;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: radial-gradient(circle at left, rgba(250, 204, 21, 0.12), transparent),
        rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(75, 85, 99, 0.8);
    }

    .status-text strong {
      color: var(--accent);
    }

    .status-danger {
      color: var(--danger);
      font-weight: 600;
    }

    /* Silindir alanƒ± */
    .gun-panel {
      margin-top: 18px;
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), #020617);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      position: relative;
    }

    .cylinder {
      position: relative;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #4b5563, #020617 70%);
      border: 4px solid #111827;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      transform-origin: center center;
      transition: transform 0.6s cubic-bezier(0.17, 0.67, 0.4, 1.4),
        box-shadow 0.2s, background 0.2s;
    }

    .cylinder.spin {
      transform: rotate(720deg);
    }

    .cylinder.bang {
      box-shadow: 0 0 40px rgba(248, 113, 113, 0.9);
      background: radial-gradient(circle at 30% 30%, #991b1b, #020617 80%);
    }

    .cylinder-hole {
      position: absolute;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #020617, #020617 60%, #111827 100%);
      border: 2px solid #111827;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
    }

    .cylinder-hole.current {
      outline: 2px solid #facc15;
      outline-offset: 2px;
      box-shadow: 0 0 12px rgba(250, 204, 21, 0.8);
    }

    .cylinder-core {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #020617, #111827);
      border: 3px solid #0b1120;
      box-shadow: 0 0 0 4px #020617, inset 0 8px 15px rgba(0, 0, 0, 0.8);
    }

    .trigger-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      align-items: center;
    }

    .log {
      margin-top: 12px;
      font-size: 0.8rem;
      color: var(--text-soft);
      max-height: 120px;
      overflow-y: auto;
      align-self: stretch;
    }

    .log-line {
      margin-bottom: 4px;
    }

    .error {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 6px;
    }

    a.link {
      color: var(--accent);
      font-size: 0.85rem;
      word-break: break-all;
    }

    /* Olasƒ±lƒ±k barƒ± */
    .prob-container {
      position: absolute;
      right: 8px;
      bottom: 8px;
      min-width: 210px;
      max-width: 260px;
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .prob-label {
      margin-bottom: 4px;
    }

    .prob-track {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      overflow: hidden;
    }

    .prob-fill {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(to right, #22c55e, #eab308, #ef4444);
      transition: width 0.2s ease-out;
    }

    /* Dil se√ßici */
    .lang-switch {
      position: absolute;
      right: 12px;
      top: 12px;
      display: flex;
      gap: 6px;
    }

    .lang-btn {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.8);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      cursor: pointer;
    }

    .lang-btn.active {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 12px rgba(250, 204, 21, 0.35);
    }

    @media (max-width: 768px) {
      .card {
        padding: 16px;
      }
      .cylinder {
        width: 130px;
        height: 130px;
      }
      .prob-container {
        position: static;
        margin-top: 8px;
        width: 100%;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card">
    <!-- Dil se√ßici -->
    <div class="lang-switch">
      <button class="lang-btn active" data-lang="tr">üáπüá∑ TR</button>
      <button class="lang-btn" data-lang="en">üá¨üáß EN</button>
    </div>

    <h1>
      <span class="icon">üéØ</span>
      <span id="title-text">Online Rus Ruleti</span>
    </h1>
    <div class="subtitle" id="subtitle-text">
      Kur oda kodunu payla≈ü, herkes baƒülansƒ±n. Silindir d√∂ns√ºn, kimse merminin nerede olduƒüunu bilmesin.
    </div>

    <!-- Kurulum -->
    <div class="row" id="setup-section">
      <div class="col">
        <div class="section-title" id="create-section-title">Yeni Oyun Olu≈ütur</div>
        <label id="label-creator-name">ƒ∞smin</label>
        <input id="creator-name" placeholder="Umut, Nova, vs." />

        <label style="margin-top:8px;" id="label-cylinder-size">≈ûarj√∂r B√ºy√ºkl√ºƒü√º (yuva sayƒ±sƒ±)</label>
        <select id="cylinder-size">
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
        </select>

        <label style="margin-top:8px;" id="label-bullet-count">Mermi Sayƒ±sƒ±</label>
        <select id="bullet-count">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>

        <button id="create-game-btn" style="margin-top:12px;">
          <span id="btn-create-text">Oyun Olu≈ütur</span> <span>‚ûï</span>
        </button>
        <div id="create-error" class="error"></div>
      </div>

      <div class="col">
        <div class="section-title" id="join-section-title">Koda / Linke G√∂re Katƒ±l</div>

        <label id="label-join-name">ƒ∞smin</label>
        <input id="join-name" placeholder="ƒ∞smin" />

        <label style="margin-top:8px;" id="label-join-code">Oda Kodu</label>
        <input id="join-code" placeholder="√ñrn: ABCD12" />

        <button id="join-game-btn" style="margin-top:12px;" class="secondary">
          <span id="btn-join-text">Oyuna Katƒ±l</span> <span>‚û°Ô∏è</span>
        </button>
        <div id="join-help-text" style="margin-top:8px;font-size:0.8rem;color:var(--text-soft);">
          Eƒüer linkle geldiysen kod otomatik dolabilir.
        </div>
        <div id="join-error" class="error"></div>
      </div>
    </div>

    <!-- Oyun ekranƒ± -->
    <div id="game-section" style="display:none; margin-top:16px;">
      <div class="row">
        <div class="col">
          <div class="section-title" id="room-section-title">Oda</div>
          <div class="pill" id="room-pill">
            <span class="pill-dot"></span>
            <span id="room-status-text">Bekleniyor...</span>
          </div>
          <div style="margin-top:8px;font-size:0.85rem;">
            <span id="room-code-label">Oda kodu:</span> <strong id="room-code">-</strong>
          </div>
          <div style="margin-top:4px;font-size:0.8rem;">
            <span id="room-link-label">Link:</span>
            <a id="room-link" class="link" href="#"></a>
          </div>
        </div>
        <div class="col">
          <div class="section-title" id="players-section-title">Oyuncular</div>
          <div class="players" id="players-list"></div>
        </div>
      </div>

      <div class="status-banner" id="status-banner">
        <div class="status-text" id="status-text">
          Oyun hen√ºz ba≈ülamadƒ±.
        </div>
        <div id="status-actions"></div>
      </div>

      <div class="gun-panel">
        <div class="section-title" id="cylinder-section-title">Silindir</div>
        <div class="cylinder" id="cylinder">
          <div class="cylinder-core"></div>
        </div>

        <div class="trigger-row">
          <button id="trigger-btn" disabled>
            <span id="btn-trigger-text">üî´ Tetiƒüi √áek</span>
          </button>
          <button id="spin-btn" class="secondary" disabled>
            <span id="btn-spin-text">Silindiri D√∂nd√ºr</span>
          </button>
        </div>

        <!-- Olasƒ±lƒ±k barƒ± -->
        <div class="prob-container">
          <div class="prob-label" id="prob-label">
            Sonraki atƒ±≈üta isabet ihtimali: ‚Äî
          </div>
          <div class="prob-track">
            <div class="prob-fill" id="prob-fill"></div>
          </div>
        </div>

        <div class="log" id="log"></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // TODO: KENDƒ∞ PROJE Bƒ∞LGƒ∞LERƒ∞Nƒ∞ YAZ
  const SUPABASE_URL = "https://tkggowekxmnlixwinszl.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRrZ2dvd2VreG1ubGl4d2luc3psIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MzI1NjcsImV4cCI6MjA4MDMwODU2N30.y1GSvarl9YyBqMaP8x6SXeD88EJ10gjee4rlr6oLyZg";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const LS_KEY = "rr_state_v2";
  const LS_LANG = "rr_lang";

  // --- Dil / i18n ---

  let currentLang = (localStorage.getItem(LS_LANG) || "tr");

  const textMap = {
    tr: {
      title: "Online Rus Ruleti",
      subtitle: "Kur oda kodunu payla≈ü, herkes baƒülansƒ±n. Silindir d√∂ns√ºn, kimse merminin nerede olduƒüunu bilmesin.",
      createSectionTitle: "Yeni Oyun Olu≈ütur",
      joinSectionTitle: "Koda / Linke G√∂re Katƒ±l",
      labelCreatorName: "ƒ∞smin",
      labelCylinderSize: "≈ûarj√∂r B√ºy√ºkl√ºƒü√º (yuva sayƒ±sƒ±)",
      labelBulletCount: "Mermi Sayƒ±sƒ±",
      labelJoinName: "ƒ∞smin",
      labelJoinCode: "Oda Kodu",
      btnCreate: "Oyun Olu≈ütur",
      btnJoin: "Oyuna Katƒ±l",
      joinHelp: "Eƒüer linkle geldiysen kod otomatik dolabilir.",
      roomSectionTitle: "Oda",
      roomCodeLabel: "Oda kodu:",
      roomLinkLabel: "Link:",
      playersSectionTitle: "Oyuncular",
      cylinderSectionTitle: "Silindir",
      btnTrigger: "üî´ Tetiƒüi √áek",
      btnSpin: "Silindiri D√∂nd√ºr",
      statusWaiting: "Oyun hen√ºz ba≈ülamadƒ±. Oyuncular girebilir.",
      statusRunningPrefix: "Sƒ±ra:",
      statusFinishedDead: (name) => `${name} BANG! Kaybetti.`,
      statusFinishedGeneric: "BANG! Mermi patladƒ±.",
      errorNameRequired: "ƒ∞smini yazmalƒ±sƒ±n.",
      errorCodeRequired: "Oda kodu bo≈ü olamaz.",
      errorRoomNotFound: "B√∂yle bir oda bulunamadƒ±.",
      logGameCreated: (slug) => `Oyun olu≈üturuldu. Kod: ${slug}`,
      logJoined: (slug) => `Odaya katƒ±ldƒ±n. Kod: ${slug}`,
      logStart: (name) => `Oyun ba≈üladƒ±. ƒ∞lk oyuncu: ${name}`,
      logNeedTwoPlayers: "En az 2 canlƒ± oyuncu olmalƒ±.",
      logSpin: "Silindir d√∂nd√ºr√ºld√º.",
      logHit: (name) => `BANG! ${name} gitti, ruhuna Fatiha.`,
      logReset: "Yeni tur i√ßin hazƒ±r. Oyuncular bekleniyor.",
      probPrefix: "Sonraki atƒ±≈üta isabet ihtimali:",
      probUnknown: "‚Äî",
      btnStartGame: "Oyunu Ba≈ülat",
      btnPlayAgain: "Tekrar Oyna (Aynƒ± Oda)",
      btnNewRoom: "Yeni Oda Kur",
    },
    en: {
      title: "Online Russian Roulette",
      subtitle: "Create a room, share the code, let everyone join. Spin the cylinder, nobody knows where the bullet is.",
      createSectionTitle: "Create New Game",
      joinSectionTitle: "Join with Code / Link",
      labelCreatorName: "Your name",
      labelCylinderSize: "Cylinder Size (chambers)",
      labelBulletCount: "Number of Bullets",
      labelJoinName: "Your name",
      labelJoinCode: "Room Code",
      btnCreate: "Create Game",
      btnJoin: "Join Game",
      joinHelp: "If you came via link, the code may be filled automatically.",
      roomSectionTitle: "Room",
      roomCodeLabel: "Room code:",
      roomLinkLabel: "Link:",
      playersSectionTitle: "Players",
      cylinderSectionTitle: "Cylinder",
      btnTrigger: "üî´ Pull the Trigger",
      btnSpin: "Spin Cylinder",
      statusWaiting: "Game has not started yet. Players can still join.",
      statusRunningPrefix: "Turn:",
      statusFinishedDead: (name) => `${name} BANG! is out.`,
      statusFinishedGeneric: "BANG! The bullet fired.",
      errorNameRequired: "Please enter your name.",
      errorCodeRequired: "Room code cannot be empty.",
      errorRoomNotFound: "Room not found.",
      logGameCreated: (slug) => `Game created. Code: ${slug}`,
      logJoined: (slug) => `Joined room. Code: ${slug}`,
      logStart: (name) => `Game started. First player: ${name}`,
      logNeedTwoPlayers: "At least 2 alive players are required.",
      logSpin: "Cylinder spun.",
      logHit: (name) => `BANG! ${name} is gone.`,
      logReset: "Ready for a new round. Waiting for players.",
      probPrefix: "Chance to hit on next shot:",
      probUnknown: "‚Äî",
      btnStartGame: "Start Game",
      btnPlayAgain: "Play Again (Same Room)",
      btnNewRoom: "Create New Room",
    },
  };

  const funMessages = {
    tr: {
      safe: [
        (name) => `${name}: Bo≈ü √ßƒ±ktƒ±, ≈üimdilik hayat devam.`,
        (name) => `${name}: Mermi seni sevmi≈ü, yine de ƒ±skaladƒ±.`,
        (name) => `${name}: ≈ûanslƒ± g√ºn√ºndesin, kafan hala bir par√ßa.`,
        (name) => `${name}: Tƒ±k! Kalp gitti geldi ama sorun yok.`,
        (name) => `${name}: Yine yƒ±rttƒ±n, Rabbine ≈ü√ºkret üëç`,
      ],
      hit: [
        (name) => `BANG! ${name} i√ßin lobby zamanƒ±...`,
        (name) => `BANG! ${name} disconnect oldu gibi d√º≈ü√ºnelim.`,
        (name) => `BANG! ${name} istifa etti bu d√ºnyadan.`,
        (name) => `BANG! ${name} respawn ekranƒ±nda ≈üu an.`,
      ],
    },
    en: {
      safe: [
        (name) => `${name}: Click! Still breathing, somehow.`,
        (name) => `${name}: Bullet changed its mind at the last second.`,
        (name) => `${name}: Lucky round, your head is still attached.`,
        (name) => `${name}: Click! Heart stopped for a second, but you're good.`,
        (name) => `${name}: You dodged that one. For now...`,
      ],
      hit: [
        (name) => `BANG! ${name} just rage-quit life.`,
        (name) => `BANG! ${name} has left the lobby.`,
        (name) => `BANG! ${name} hit the respawn screen.`,
        (name) => `BANG! ${name} took the full update package.`,
      ],
    },
  };

  function pickRandomMessage(type, name) {
    const set = funMessages[currentLang][type];
    const fn = set[Math.floor(Math.random() * set.length)];
    return fn(name);
  }

  function applyLanguage() {
    const t = textMap[currentLang];

    document.getElementById("title-text").textContent = t.title;
    document.getElementById("subtitle-text").textContent = t.subtitle;

    document.getElementById("create-section-title").textContent = t.createSectionTitle;
    document.getElementById("join-section-title").textContent = t.joinSectionTitle;
    document.getElementById("label-creator-name").textContent = t.labelCreatorName;
    document.getElementById("label-cylinder-size").textContent = t.labelCylinderSize;
    document.getElementById("label-bullet-count").textContent = t.labelBulletCount;
    document.getElementById("label-join-name").textContent = t.labelJoinName;
    document.getElementById("label-join-code").textContent = t.labelJoinCode;

    document.getElementById("btn-create-text").textContent = t.btnCreate;
    document.getElementById("btn-join-text").textContent = t.btnJoin;
    document.getElementById("join-help-text").textContent = t.joinHelp;

    document.getElementById("room-section-title").textContent = t.roomSectionTitle;
    document.getElementById("room-code-label").textContent = t.roomCodeLabel;
    document.getElementById("room-link-label").textContent = t.roomLinkLabel;
    document.getElementById("players-section-title").textContent = t.playersSectionTitle;
    document.getElementById("cylinder-section-title").textContent = t.cylinderSectionTitle;

    document.getElementById("btn-trigger-text").textContent = t.btnTrigger;
    document.getElementById("btn-spin-text").textContent = t.btnSpin;

    updateRoomUI();
    updateProbability();
  }

  // --- Ses (Web Audio ile, dosyasƒ±z) ---
  let audioCtx = null;
  function getAudioCtx() {
    if (!audioCtx) {
      const AC = window.AudioContext || window.webkitAudioContext;
      if (AC) audioCtx = new AC();
    }
    return audioCtx;
  }

  function playClickSound() {
    const ctx = getAudioCtx();
    if (!ctx) return;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = "square";
    osc.frequency.setValueAtTime(1200, ctx.currentTime);
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.08);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 0.1);
  }

  function playBangSound() {
    const ctx = getAudioCtx();
    if (!ctx) return;

    const length = ctx.sampleRate * 0.35; // 350ms
    const buffer = ctx.createBuffer(1, length, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < length; i++) {
      data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
    }

    const noise = ctx.createBufferSource();
    noise.buffer = buffer;

    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0.8, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.35);

    noise.connect(gain);
    gain.connect(ctx.destination);
    noise.start();
  }

  function playSpinSound() {
    const ctx = getAudioCtx();
    if (!ctx) return;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = "sawtooth";
    osc.frequency.setValueAtTime(400, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.4);
    gain.gain.setValueAtTime(0.12, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 0.45);
  }

  // --- Helpers ---
  function randomSlug(len = 6) {
    return Math.random().toString(36).substring(2, 2 + len).toUpperCase();
  }

  function createCylinderPattern(cylinderSize, bulletCount) {
    const size = Number(cylinderSize);
    const bullets = Number(bulletCount);
    const pattern = Array(size).fill(0);
    let placed = 0;
    while (placed < bullets) {
      const idx = Math.floor(Math.random() * size);
      if (pattern[idx] === 0) {
        pattern[idx] = 1;
        placed++;
      }
    }
    return pattern.join("");
  }

  function log(message) {
    const logEl = document.getElementById("log");
    const div = document.createElement("div");
    div.className = "log-line";
    const time = new Date().toLocaleTimeString();
    div.textContent = `[${time}] ${message}`;
    logEl.prepend(div);
  }

  function renderCylinder(pattern) {
    const cyl = document.getElementById("cylinder");
    cyl.innerHTML = '<div class="cylinder-core"></div>';

    if (!pattern) return;

    const size = pattern.length;
    const radius = 55;
    for (let i = 0; i < size; i++) {
      const angle = (2 * Math.PI * i) / size - Math.PI / 2;
      const x = Math.cos(angle) * radius;
      const y = Math.sin(angle) * radius;

      const hole = document.createElement("div");
      hole.className = "cylinder-hole";

      // Mermi g√∂r√ºnm√ºyor, sadece ate≈ülenecek yuva (0. indeks) vurgulu
      if (i === 0) {
        hole.classList.add("current");
      }

      hole.style.transform = `translate(${x}px, ${y}px)`;
      cyl.appendChild(hole);
    }
  }

  function saveLocalState() {
    if (!currentGame || !currentPlayer) return;
    const payload = {
      gameSlug: currentGame.slug,
      playerId: currentPlayer.id,
    };
    try {
      localStorage.setItem(LS_KEY, JSON.stringify(payload));
    } catch (_) {}
  }

  function clearLocalState() {
    try {
      localStorage.removeItem(LS_KEY);
    } catch (_) {}
  }

  // --- State ---
  let currentGame = null;
  let currentPlayer = null;
  let players = [];
  let isCreator = false;
  let pollInterval = null;

  // --- DOM refs ---
  const setupSection = document.getElementById("setup-section");
  const gameSection = document.getElementById("game-section");
  const roomCodeEl = document.getElementById("room-code");
  const roomLinkEl = document.getElementById("room-link");
  const roomStatusText = document.getElementById("room-status-text");
  const playersList = document.getElementById("players-list");
  const statusText = document.getElementById("status-text");
  const statusActions = document.getElementById("status-actions");
  const triggerBtn = document.getElementById("trigger-btn");
  const spinBtn = document.getElementById("spin-btn");
  const cylinderEl = document.getElementById("cylinder");
  const probLabelEl = document.getElementById("prob-label");
  const probFillEl = document.getElementById("prob-fill");

  function updateProbability() {
    const t = textMap[currentLang];

    if (!currentGame || currentGame.status !== "running") {
      probLabelEl.textContent = `${t.probPrefix} ${t.probUnknown}`;
      probFillEl.style.width = "0%";
      return;
    }

    const pattern = currentGame.cylinder_pattern;
    const idx = currentGame.current_index;
    if (!pattern || typeof idx !== "number") {
      probLabelEl.textContent = `${t.probPrefix} ${t.probUnknown}`;
      probFillEl.style.width = "0%";
      return;
    }

    const remaining = pattern.slice(idx);
    const bulletsRemaining = (remaining.match(/1/g) || []).length;
    const chambersRemaining = pattern.length - idx;

    if (chambersRemaining <= 0) {
      probLabelEl.textContent = `${t.probPrefix} ${t.probUnknown}`;
      probFillEl.style.width = "0%";
      return;
    }

    const prob = (bulletsRemaining / chambersRemaining) * 100;
    const display = prob.toFixed(1);

    if (currentLang === "tr") {
      probLabelEl.textContent = `${t.probPrefix} %${display}`;
    } else {
      probLabelEl.textContent = `${t.probPrefix} ${display}%`;
    }
    probFillEl.style.width = `${Math.min(100, prob)}%`;
  }

  function updateRoomUI() {
    if (!currentGame) return;
    const t = textMap[currentLang];

    roomCodeEl.textContent = currentGame.slug;
    const link = `${window.location.origin}${window.location.pathname}?game=${currentGame.slug}`;
    roomLinkEl.href = link;
    roomLinkEl.textContent = link;

    let statusLabel = "‚Ä¶";
    if (currentGame.status === "waiting") statusLabel = t.statusWaiting;
    if (currentGame.status === "running") statusLabel =
      currentLang === "tr" ? "Oyun devam ediyor" : "Game in progress";
    if (currentGame.status === "finished") statusLabel =
      currentLang === "tr" ? "Oyun bitti" : "Game over";

    roomStatusText.textContent = statusLabel;

    // players list
    playersList.innerHTML = "";
    players.forEach((p) => {
      const row = document.createElement("div");
      row.className = "player-row";
      const left = document.createElement("div");
      left.className = "player-name";

      const dot = document.createElement("div");
      dot.className = "player-dot";
      if (!p.is_alive) dot.classList.add("dead");

      left.appendChild(dot);
      const nameSpan = document.createElement("span");
      nameSpan.textContent = p.name;
      left.appendChild(nameSpan);

      const right = document.createElement("div");
      if (p.is_creator) {
        const creatorTag = document.createElement("span");
        creatorTag.className = "player-tag";
        creatorTag.textContent = currentLang === "tr" ? "Kurucu" : "Host";
        right.appendChild(creatorTag);
      }
      if (currentGame.current_player_id === p.id && currentGame.status === "running") {
        const turnTag = document.createElement("span");
        turnTag.className = "player-tag";
        turnTag.style.borderColor = "#facc15";
        turnTag.style.color = "#facc15";
        turnTag.textContent = currentLang === "tr" ? "Sƒ±ra" : "Turn";
        right.appendChild(turnTag);
      }

      row.appendChild(left);
      row.appendChild(right);
      playersList.appendChild(row);
    });

    // banner text
    let banner = "";
    if (currentGame.status === "waiting") {
      banner = t.statusWaiting;
    } else if (currentGame.status === "running") {
      const current = players.find((p) => p.id === currentGame.current_player_id);
      if (current) {
        banner = `${t.statusRunningPrefix} <strong>${current.name}</strong>`;
      } else {
        banner = currentLang === "tr"
          ? "Sƒ±ra bilgisi hazƒ±rlanƒ±yor..."
          : "Turn info is loading...";
      }
    } else if (currentGame.status === "finished") {
      const dead = players.find((p) => !p.is_alive);
      if (dead) {
        banner = `<span class="status-danger">${textMap[currentLang].statusFinishedDead(dead.name)}</span>`;
      } else {
        banner = `<span class="status-danger">${textMap[currentLang].statusFinishedGeneric}</span>`;
      }
    }
    statusText.innerHTML = banner;

    // status actions
    statusActions.innerHTML = "";
    if (isCreator && currentGame.status === "waiting") {
      const btn = document.createElement("button");
      btn.textContent = t.btnStartGame;
      btn.onclick = startGame;
      statusActions.appendChild(btn);
    } else if (currentGame.status === "finished" && isCreator) {
      const again = document.createElement("button");
      again.textContent = t.btnPlayAgain;
      again.onclick = restartGame;
      statusActions.appendChild(again);

      const newGame = document.createElement("button");
      newGame.className = "secondary";
      newGame.style.marginLeft = "8px";
      newGame.textContent = t.btnNewRoom;
      newGame.onclick = () => {
        clearLocalState();
        window.location.href = window.location.pathname;
      };
      statusActions.appendChild(newGame);
    }

    // trigger / spin buttons
    const myTurn =
      currentGame.status === "running" &&
      currentGame.current_player_id === currentPlayer?.id &&
      currentPlayer?.is_alive;

    triggerBtn.disabled = !myTurn;
    spinBtn.disabled = !myTurn;

    // cylinder (mermi g√∂r√ºnm√ºyor, sadece ate≈ülenecek yuva i≈üaretli)
    renderCylinder(currentGame.cylinder_pattern);
    updateProbability();
  }

  async function fetchPlayers(gameId) {
    const { data, error } = await supabase
      .from("rr_players")
      .select("*")
      .eq("game_id", gameId)
      .order("created_at", { ascending: true });

    if (!error) {
      players = data;
      if (currentPlayer) {
        const me = players.find((p) => p.id === currentPlayer.id);
        if (me) currentPlayer = me;
      }
      updateRoomUI();
    }
  }

  async function fetchGameBySlug(slug) {
    const { data, error } = await supabase
      .from("rr_games")
      .select("*")
      .eq("slug", slug)
      .single();
    if (error) return null;
    return data;
  }

  async function fetchGameById(id) {
    const { data, error } = await supabase
      .from("rr_games")
      .select("*")
      .eq("id", id)
      .single();
    if (error) return null;
    return data;
  }

  async function fetchPlayerById(id) {
    const { data, error } = await supabase
      .from("rr_players")
      .select("*")
      .eq("id", id)
      .single();
    if (error) return null;
    return data;
  }

  async function pollGameState() {
    if (!currentGame) return;
    const game = await fetchGameById(currentGame.id);
    if (game) {
      currentGame = game;
      await fetchPlayers(game.id);
      updateRoomUI();
    }
  }

  function startPolling() {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(pollGameState, 2000);
  }

  function stopPolling() {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = null;
  }

  async function attachRealtime(gameId) {
    supabase
      .channel("rr-game-" + gameId)
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "rr_games", filter: `id=eq.${gameId}` },
        (payload) => {
          if (payload.new) {
            currentGame = payload.new;
            updateRoomUI();
            fetchPlayers(gameId);
          }
        }
      )
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "rr_players", filter: `game_id=eq.${gameId}` },
        () => {
          fetchPlayers(gameId);
        }
      )
      .subscribe((status) => {
        console.log("Realtime status:", status);
      });

    // Realtime √ßalƒ±≈ümasa bile polling backup
    startPolling();
  }

  async function createGame() {
    const t = textMap[currentLang];
    const name = document.getElementById("creator-name").value.trim();
    const cyl = document.getElementById("cylinder-size").value;
    const bullets = document.getElementById("bullet-count").value;
    const errEl = document.getElementById("create-error");
    errEl.textContent = "";

    if (!name) {
      errEl.textContent = t.errorNameRequired;
      return;
    }

    const pattern = createCylinderPattern(cyl, bullets);
    const slug = randomSlug();

    const { data: game, error } = await supabase
      .from("rr_games")
      .insert({
        slug,
        cylinder_size: Number(cyl),
        bullet_count: Number(bullets),
        cylinder_pattern: pattern,
        status: "waiting",
        creator_name: name,
      })
      .select()
      .single();

    if (error) {
      console.error(error);
      errEl.textContent = "Oyun olu≈üturulamadƒ±: " + error.message;
      return;
    }

    const { data: player, error: pError } = await supabase
      .from("rr_players")
      .insert({
        game_id: game.id,
        name,
        is_creator: true,
      })
      .select()
      .single();

    if (pError) {
      console.error(pError);
      errEl.textContent = "Oyuncu eklenemedi: " + pError.message;
      return;
    }

    isCreator = true;
    currentGame = game;
    currentPlayer = player;

    setupSection.style.display = "none";
    gameSection.style.display = "block";
    log(textMap[currentLang].logGameCreated(game.slug));

    saveLocalState();
    updateRoomUI();
    attachRealtime(game.id);
    await fetchPlayers(game.id);
  }

  async function joinGameByCode() {
    const t = textMap[currentLang];
    const name = document.getElementById("join-name").value.trim();
    const code = document.getElementById("join-code").value.trim().toUpperCase();
    const errEl = document.getElementById("join-error");
    errEl.textContent = "";

    if (!name) {
      errEl.textContent = t.errorNameRequired;
      return;
    }
    if (!code) {
      errEl.textContent = t.errorCodeRequired;
      return;
    }

    const game = await fetchGameBySlug(code);
    if (!game) {
      errEl.textContent = t.errorRoomNotFound;
      return;
    }

    const { data: player, error: pError } = await supabase
      .from("rr_players")
      .insert({
        game_id: game.id,
        name,
        is_creator: false,
      })
      .select()
      .single();

    if (pError) {
      errEl.textContent = "Oyuncu eklenemedi: " + pError.message;
      return;
    }

    isCreator = !!player.is_creator;
    currentGame = game;
    currentPlayer = player;

    setupSection.style.display = "none";
    gameSection.style.display = "block";
    log(textMap[currentLang].logJoined(game.slug));

    saveLocalState();
    updateRoomUI();
    attachRealtime(game.id);
    await fetchPlayers(game.id);
  }

  async function startGame() {
    if (!currentGame || !isCreator) return;
    const t = textMap[currentLang];

    const alivePlayers = players.filter((p) => p.is_alive);
    if (alivePlayers.length < 2) {
      log(t.logNeedTwoPlayers);
      return;
    }
    const firstAlive = alivePlayers[0];
    if (!firstAlive) return;

    const { data, error } = await supabase
      .from("rr_games")
      .update({
        status: "running",
        started_at: new Date().toISOString(),
        current_player_id: firstAlive.id,
        current_index: 0,
      })
      .eq("id", currentGame.id)
      .select()
      .single();

    if (error) {
      log("Oyun ba≈ülatƒ±lamadƒ±: " + error.message);
      return;
    }

    currentGame = data;
    log(textMap[currentLang].logStart(firstAlive.name));
    cylinderEl.classList.add("spin");
    playSpinSound();
    setTimeout(() => cylinderEl.classList.remove("spin"), 600);
    updateRoomUI();
  }

  function getNextAlivePlayer(currentId) {
    const alive = players.filter((p) => p.is_alive);
    if (alive.length === 0) return null;
    const idx = alive.findIndex((p) => p.id === currentId);
    if (idx === -1) return alive[0];
    return alive[(idx + 1) % alive.length];
  }

  async function pullTrigger() {
    if (!currentGame || !currentPlayer) return;
    if (currentGame.status !== "running") return;
    if (currentGame.current_player_id !== currentPlayer.id) return;
    if (!currentPlayer.is_alive) return;

    const t = textMap[currentLang];

    cylinderEl.classList.add("spin");
    playSpinSound();
    setTimeout(() => cylinderEl.classList.remove("spin"), 600);

    const pattern = currentGame.cylinder_pattern;
    const idx = currentGame.current_index;
    const hit = pattern && pattern[idx] === "1";
    const newIndex = idx + 1;

    if (hit) {
      // BANG
      playBangSound();
      cylinderEl.classList.add("bang");
      setTimeout(() => cylinderEl.classList.remove("bang"), 350);
      log(pickRandomMessage("hit", currentPlayer.name));

      const { error: pError } = await supabase
        .from("rr_players")
        .update({ is_alive: false })
        .eq("id", currentPlayer.id);

      if (pError) {
        log("Oyuncu g√ºncellenemedi: " + pError.message);
      }

      const { data: updatedGame, error: gError } = await supabase
        .from("rr_games")
        .update({
          status: "finished",
          ended_at: new Date().toISOString(),
          current_index: newIndex,
        })
        .eq("id", currentGame.id)
        .select()
        .single();

      if (!gError && updatedGame) {
        currentGame = updatedGame;
        updateRoomUI();
      }
    } else {
      // Bo≈ü
      playClickSound();
      log(pickRandomMessage("safe", currentPlayer.name));
      const next = getNextAlivePlayer(currentPlayer.id);

      const { data: updatedGame, error } = await supabase
        .from("rr_games")
        .update({
          current_index: newIndex,
          current_player_id: next ? next.id : currentPlayer.id,
        })
        .eq("id", currentGame.id)
        .select()
        .single();

      if (!error && updatedGame) {
        currentGame = updatedGame;
        updateRoomUI();
      }
    }
  }

  async function restartGame() {
    if (!currentGame || !isCreator) return;

    const pattern = createCylinderPattern(
      currentGame.cylinder_size,
      currentGame.bullet_count
    );

    const { error: pError } = await supabase
      .from("rr_players")
      .update({ is_alive: true })
      .eq("game_id", currentGame.id);

    if (pError) {
      log("Oyuncular resetlenemedi: " + pError.message);
      return;
    }

    const { data: updatedGame, error: gError } = await supabase
      .from("rr_games")
      .update({
        status: "waiting",
        cylinder_pattern: pattern,
        current_index: 0,
        current_player_id: null,
        started_at: null,
        ended_at: null,
      })
      .eq("id", currentGame.id)
      .select()
      .single();

    if (gError) {
      log("Oyun resetlenemedi: " + gError.message);
      return;
    }

    currentGame = updatedGame;
    log(textMap[currentLang].logReset);
    updateRoomUI();
    await fetchPlayers(currentGame.id);
  }

  async function autoRejoinIfPossible() {
    // URL'de game param varsa join-code'u dolduralƒ±m
    const params = new URLSearchParams(window.location.search);
    const gameSlugParam = params.get("game");
    if (gameSlugParam) {
      document.getElementById("join-code").value = gameSlugParam.toUpperCase();
    }

    // local state varsa otomatik baƒülanmayƒ± dene
    let saved = null;
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (raw) saved = JSON.parse(raw);
    } catch (_) {}

    if (!saved?.gameSlug || !saved?.playerId) return;

    const game = await fetchGameBySlug(saved.gameSlug);
    const player = await fetchPlayerById(saved.playerId);

    if (!game || !player) {
      clearLocalState();
      return;
    }

    currentGame = game;
    currentPlayer = player;
    isCreator = !!player.is_creator;

    setupSection.style.display = "none";
    gameSection.style.display = "block";
    log(textMap[currentLang].logJoined(game.slug));

    updateRoomUI();
    attachRealtime(game.id);
    await fetchPlayers(game.id);
  }

  // --- Event bindings ---
  document.getElementById("create-game-btn").onclick = createGame;
  document.getElementById("join-game-btn").onclick = joinGameByCode;
  triggerBtn.onclick = () => {
    getAudioCtx(); // ilk tƒ±klamada AudioContext aktif olsun
    pullTrigger();
  };
  spinBtn.onclick = () => {
    getAudioCtx();
    cylinderEl.classList.add("spin");
    playSpinSound();
    setTimeout(() => cylinderEl.classList.remove("spin"), 600);
    log(textMap[currentLang].logSpin);
  };

  // Dil butonlarƒ±
  const langButtons = document.querySelectorAll(".lang-btn");
  langButtons.forEach((btn) => {
    const lang = btn.dataset.lang;
    if (lang === currentLang) btn.classList.add("active");
    btn.addEventListener("click", () => {
      currentLang = lang;
      localStorage.setItem(LS_LANG, currentLang);
      langButtons.forEach((b) =>
        b.classList.toggle("active", b.dataset.lang === currentLang)
      );
      applyLanguage();
    });
  });

  // Init
  applyLanguage();
  autoRejoinIfPossible();
</script>
</body>
</html>
